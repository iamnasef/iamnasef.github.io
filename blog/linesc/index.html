<!doctype html><html lang=en-us><head><script type=application/javascript>var doNotTrack=!1;doNotTrack||(function(a,e,f,g,b,c,d){a.GoogleAnalyticsObject=b,a[b]=a[b]||function(){(a[b].q=a[b].q||[]).push(arguments)},a[b].l=1*new Date,c=e.createElement(f),d=e.getElementsByTagName(f)[0],c.async=1,c.src=g,d.parentNode.insertBefore(c,d)}(window,document,'script','https://www.google-analytics.com/analytics.js','ga'),ga('create','UA-194024736-1','auto'),ga('send','pageview'))</script><meta charset=utf-8><title>The Ultimate Linux Privilege Escalation Guide for OSCP & CTF</title><meta name=viewport content="width=device-width,initial-scale=1"><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><meta name=author content="Nasef"><meta name=generator content="Hugo 0.85.0"><link rel=stylesheet href=https://iamnasef.com/css/bootstrap.min.css><link rel=stylesheet href=https://iamnasef.com/font-awesome/css/font-awesome.min.css><link href=https://iamnasef.com/scss/style.min.css rel=stylesheet><link rel="shortcut icon" href=https://iamnasef.com/images/favicon.png type=image/x-icon><link rel=icon href=https://iamnasef.com/images/favicon.ico type=image/x-icon></head><body><nav class="navbar navbar-expand-lg site-navigation"><div class=container><a class=navbar-brand href=https://iamnasef.com/><img src=https://iamnasef.com/images/logo.png alt=logo></a>
<button class="navbar-toggler collapsed" type=button data-toggle=collapse data-target=#sitenavbar>
<span class=icon-bar></span><span class=icon-bar></span><span class=icon-bar></span></button><div class="collapse navbar-collapse" id=sitenavbar><ul class="navbar-nav ml-auto main-nav"><li class=nav-item><a class=nav-link href=https://iamnasef.com/>Home</a></li><li class=nav-item><a class=nav-link href=https://iamnasef.com/projects>Projects</a></li><li class=nav-item><a class=nav-link href=https://iamnasef.com/courses>Courses</a></li><li class=nav-item><a class=nav-link href=https://iamnasef.com/blog>Blog</a></li><li class=nav-item><a class="nav-link btn btn-sm btn-primary btn-sm-rounded" href=https://iamnasef.com/contact><span class=btn-area><span data-text="Contact Me">Contact Me</span></span></a></li></ul></div></div></nav><main><section class="site-blog details"><div class=container><div class="row justify-content-center"><div class=col-lg-8><article class=site-blog-details><p><span>December 6, 2020</span> by <span>Nasef</span></p><h2 class=blog-title>The Ultimate Linux Privilege Escalation Guide for OSCP & CTF</h2><img class=feature-image src=https://iamnasef.com/images/blog/009/featured-image.png alt=blog-feature-image><p>Privilege Escalation is a topic which most of CTF players and OSCP students struggle with. Privilege Escalation in general is to get more privilege but in this context it means getting root privilege which is the highest privilege in the system. In this article I am going to explain 7 methods of Linux privilege escalation with exploitation steps and how to fix them. But as a perquisites you must have Linux essentials for example the knowledge of how to use command line and the Linux permission model. To follow up with this tutorial we are going to use a vulnerable machine called LinESC which was created by me. You can download <a href=https://www.vulnhub.com/entry/linesc-1,616/>From Here</a>. the default user is &ldquo;muhammad&rdquo; and password is &ldquo;nasef&rdquo;.</p><h2 id=1-misconfigured-permissions>1) Misconfigured Permissions</h2><p>Some files are meant to be read only by root others can be read by anyone but write only by root. Sometimes files' permissions are misconfigured, for example the /etc/shadow which stores the passwords of the whole system. no one could read it except root.</p><h3 id=readable-etcshadow>Readable /etc/shadow</h3><p>In this machine /etc/shadow is readable by everyone. so, we could easily see the root password&rsquo;s hash and crack it using john or hashcat.</p><h3 id=exploitation-process>Exploitation Process</h3><ol><li>To check the permissions of /etc/shadow use</li></ol><pre><code>ls -la /etc/ | grep shadow
</code></pre><ol start=2><li>If it&rsquo;s readable you could view the hash by</li></ol><pre><code>cat /etc/shadow
</code></pre><p><img src=/images/blog/009/6.png alt=Username>
3. store the hash in a file and run john over it using the rockyou wordlist.
<img src=/images/blog/009/7.png alt=Username></p><h3 id=solution>Solution</h3><p>Set the suitable permission for the suitable file. In this case we should remove the reading permission from the other users.</p><h2 id=2-sudo>2) SUDO</h2><p>SUDO is a feature in Linux which allows User A to execute certain commands as User B. Sometimes the user may exectue certian commands as root. so, we may abuse this feature to gain privilege escalation.</p><h3 id=exploitation-process-1>Exploitation Process</h3><ol><li>Use</li></ol><pre><code>sudo -l
</code></pre><p>to list the commands allowed for the user to execute as other users
2. As you see we can execute three commands as (root)
3. going to /home/vuln/2 we can read the source code of the script. It just starts a new shell but because we are executing this command as root. we will get root shell.</p><p><img src=/images/blog/009/8.png alt=Username></p><h3 id=solution-1>Solution</h3><p>Set the suitable permission for the suitable file. In this case remove the whole entry from /etc/sudoers.</p><h2 id=3-suid>3) SUID</h2><p>SUID is a special permission which allows any user to execute file as the owner of the file. So, if the owner of the file is root then any user may execute this file as root.</p><h3 id=exploitation-process-2>Exploitation Process</h3><ol><li>Use</li></ol><pre><code>find / -perm -4000 2&gt; /dev/null
</code></pre><p>to list all files with SUID permissions in the system.
2. We found that an executable with the name</p><pre><code>/home/muhammad/vuln/1/suid
</code></pre><p>is running.
3. going to</p><pre><code>/home/muhammad/vuln/1/
</code></pre><p>we found the source code which basically do the same thing as sudo file.
4. Because SUID is set and the owner is root we were able to get the shell as root.</p><p><img src=/images/blog/009/9.png alt=Username></p><h3 id=solution-2>Solution</h3><p>Set the suitable permission for the suitable file. In this case remove the suid permission from the file.</p><h2 id=4-cronjobs>4) CRONJOBS</h2><p>Cronjobs are scheduled commands & scripts which automatically run at certain interval of time as a specific user. If a certain script is executed at certain interval of time as root, and we are able to modify this script. we may get root shell.</p><h3 id=exploitation-process-3>Exploitation Process</h3><ol><li>Use</li></ol><pre><code>cat /etc/crontab
</code></pre><p>to list all files with SUID permissions in the system.
2. We found that a script is executed every minute as root.
3. Checking the content of the script we found that it&rsquo;s simply copies the file passwd to replace /etc/passwd so we could simply modify /etc/passwd and add another user with root permission then logging to it.</p><p><img src=/images/blog/009/10.png alt=Username>
4. Create password with mkpasswd.
<img src=/images/blog/009/11.png alt=Username></p><ol start=5><li><p>Copy the root entry from passwd file and modify the user and password with the password we created above.
<img src=/images/blog/009/12.png alt=Username></p></li><li><p>Wait 1 minute until the script is executed so you could easily su to the created user.
<img src=/images/blog/009/13.png alt=Username></p></li></ol><h3 id=solution-3>Solution</h3><p>Check the scheduled tasks for the root and remove the unnecessary ones or the ones that may be exploited. In our case remove the script.sh task.</p><h2 id=5-misconfigured-services>5) Misconfigured Services</h2><p>Some services may be misconfigured which leads to privilege escalation.</p><h3 id=nfs-no-root-squashing>NFS no-root-squashing</h3><p>A famous misconfiguration is the NFS no-root-squashing. NFS is a protocol which allows the server to share specified directories with other computers.</p><p>If computerA has two users (muhammad,root). Muhammad created a file in the share then the owner will be muhammad of computerA but the problem arises when root from computerA creates a file in the share. the NFS will confuse the root of computerA with the root of the share. So if the root in computerA created a script and added suid permission for file in the server share. then a simple user in the server may run this script as the root of the share. which is very dangerous.</p><h3 id=exploitation-process-4>Exploitation Process</h3><ol><li>Run</li></ol><pre><code>cat /etc/exports
</code></pre><p>see the exported shares.
2. You will find that /home/muhammad is shared but more importantly the no-root-squashing is enabled. So, we will exploit it.
3. In our machine mount the share using</p><pre><code>mount -o rw,vers=2 192.168.190.142:/home/muhammad /mnt/exploit/
</code></pre><ol start=4><li>Since we are root in kali Linux, then any file we create in the share will be owned by the root of the share and giving suid permission will allow user muhammad to run this file as root. so we may create a script which copies an existing passwd but with added user -as in crontab example step 4 and 5- file to /etc/passswd. anyway the I wrote this script and it&rsquo;s in /home/muhammad/vuln/4 .</li><li>Add new user in passwd as in crontab exaple step 4 and 5.</li><li>Give the script SUID and execution Permessions</li></ol><pre><code>chmod +sx script.sh
</code></pre><p><img src=/images/blog/009/16.png alt=Username>
7. From the vulnerable system run the script and voila the new root user is added!
8. su to the newly created user.</p><p><img src=/images/blog/009/17.png alt=Username></p><h3 id=solution-4>Solution</h3><p>To solve misconfigured services, we must reconfigure the service. In our case remove the no-root-squashing.</p><h2 id=6-passwords>6) Passwords</h2><p>There are some cases where root&rsquo;s password due to bad practices is available in plain sight and we will talk only about two cases because there are unlimited number of password management issues. This method of privilege escalation is hard to find because there is no direct way to find stored passwords. but it&rsquo;s useful to check the config files of the running services, because there might be password reuse. also check the system directories and try to check if there is a suspicious file.</p><h3 id=history>History</h3><p>if you typed the command history it will give you the history of commands done by the user.</p><p><img src=/images/blog/009/1.png alt=Username></p><p>Inspecting the output, you will find two important lines. The first is telling you to follow my twitter account @nasefmuhammad which you should do :D . The second is a mistyped command by the user. His intention is to su root and then type the password but instead of doing that he wrote &ldquo;sudo root chicken&rdquo;, and chicken is the root&rsquo;s password.</p><h3 id=ssh-keys>SSH Keys</h3><p>SSH identification keys may allow you in some cases to ssh login to the intended user without using password. So, you need to store the ssh keys in a secure place where the intended user is the only one has access.</p><p><img src=/images/blog/009/2.png alt=Username></p><p>In our case the root keys are stored in /home/muhammad/vuln/3/key so simply we used the ssh -i command to ssh login as root user.</p><h3 id=solution-5>Solution</h3><p>The solution for these kinds of problems are obvious. Just follow the best practices of storing passwords.</p><h2 id=7-kernel-exploitation>7) Kernel Exploitation</h2><p>Linux kernel like any software has a history of critical vulnerabilities. Some of these vulnerabilities may led to critical situations as privilege escalation, So we always need to check the kernel version then search for it in exploitdb or any other exploit databases.</p><p>We can check for kernel version using the following command</p><pre><code>uname -r
</code></pre><p><img src=/images/blog/009/3.png alt=Username></p><p>Then searching in exploitdb for suitable exploit
<img src=/images/blog/009/4.png alt=Username></p><p>A famous reoccurring exploit in ctf is dirtycow and you could read more about it <a href=%22https://dirtycow.ninja/%22>From Here</a></p><h3 id=exploitation-process-5>Exploitation Process</h3><ol><li><p>First we are going to download the exploit <a href=%22https://gist.githubusercontent.com/KrE80r/42f8629577db95782d5e4f609f437a54/raw/71c902f55c09aa8ced351690e1e627363c231b45/c0w.c%22>From Here</a></p></li><li><p>Then we are going to compile it as mentioned in the exploit.</p></li><li><p>run the exploit.</p></li><li><p>after it finishes run /usr/bin/passwd and you are root!</p></li></ol><p><img src=/images/blog/009/5.png alt=Username></p><p>After the exploitation you will found that a new user with root privileges is created and you are now root!</p><h3 id=solution-6>Solution</h3><p>The solution for kernel exploits is to keep your system updated. In our case we must ditch the 8.04 ubuntu and get a supported version.</p><h2 id=summary>Summary</h2><p>These are the most common 7 ways of getting privilege escalation in Linux system. If you have any question you can email me at <a href=mailto:me@muhammadnasef.com>me@muhammadnasef.com</a> and follow me at @nasefmuhammad in twitter. Thanks for your time!</p></article></div></div></div></section><section class=site-cta id=contact style=background-image:url(https://iamnasef.com/images/backgrounds/cta-background.jpg)><div class=container><div class=row><div class="col-12 text-center"><h1 class=site-cta-title>SAY HELLO</h1><a class=mail-link href=mailto:hello@iamnasef.com><h2 class=mail>HELLO@IAMNASEF.COM</h2></a><div class=sm-links><a href=https://twitter.com/iamnasef><i class="fa fa-twitter-square" aria-hidden=true></i></a>
<a href=https://www.linkedin.com/in/iamnasef/><i class="fa fa-linkedin-square" aria-hidden=true></i></a>
<a href=https://github.com/iamnasef><i class="fa fa-github-square" aria-hidden=true></i></a>
<a href=https://www.youtube.com/channel/UCoxP4Z6Wfz60fFtB31gyNlQ><i class="fa fa-youtube-square" aria-hidden=true></i></a></div></div></div></div></section></main><footer class=site-footer><div class=container><div class=row><div class=col-12><div class=site-footer-logo><a href=https://iamnasef.com/><img src=https://iamnasef.com/images/logo-footer.png alt=logo-footer width=100px height=100px></a></div></div><div class="col-lg-3 col-md-6"><div class=site-footer-widget><h5 class=site-footer-widget-title>Contact Info</h5><p class=site-footer-widget-description><a href=mailto:hello@iamnansef.com>hello@iamnansef.com</a></p></div></div><div class="col-lg-2 col-md-6"><div class=site-footer-widget><h5 class=site-footer-widget-title>Check it</h5><ul class=site-footer-widget-links><li><a href=https://iamnasef.com/blog>Blog</a></li><li><a href=https://iamnasef.com/projects>Projects</a></li><li><a href=https://iamnasef.com/courses>Courses</a></li><li><a href=https://iamnasef.com/contact>Contact</a></li></ul></div></div><div class="col-lg-2 col-md-6"><div class=site-footer-widget><h5 class=site-footer-widget-title>Social Media</h5><ul class=site-footer-widget-links><li><a href=https://www.linkedin.com/in/iamnasef/>Linkedin</a></li><li><a href=https://twitter.com/iamnasef>Twitter</a></li><li><a href=https://github.com/iamnasef>Github</a></li><li><a href=https://www.youtube.com/channel/UCoxP4Z6Wfz60fFtB31gyNlQ>YouTube</a></li></ul></div></div><div class="col-lg-3 col-md-6"><div class=site-footer-widget><h5 class=site-footer-widget-title>Keeping you safe</h5><p class=site-footer-widget-description>Application Security Engineering<br>Cyber Security Technical Training<br>Cyber Security Awarness</p></div></div><div class="col-lg-2 col-12"><a href=#top class=site-footer-widget-top><img src=https://iamnasef.com/images/to-top.svg alt=back-to-top><p>I want to<br>visit again</p></a></div></div></div></footer><script src=https://iamnasef.com/js/formhandler.min.js></script><script src=https://iamnasef.com/js/vendor.min.js></script><script src=https://iamnasef.com/js/script.min.js></script></body></html>